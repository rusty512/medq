<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAMQ Scan - Upload Mobile</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .container { background: white; border-radius: 20px; padding: 30px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); max-width: 400px; width: 100%; text-align: center; }
        .logo { font-size: 24px; font-weight: bold; color: #333; margin-bottom: 10px; }
        .subtitle { color: #666; margin-bottom: 30px; font-size: 14px; }
        .upload-area { border: 2px dashed #ddd; border-radius: 15px; padding: 40px 20px; margin-bottom: 20px; cursor: pointer; transition: all 0.3s ease; position: relative; overflow: hidden; }
        .upload-area:hover { border-color: #667eea; background-color: #f8f9ff; }
        .upload-area.dragover { border-color: #667eea; background-color: #f0f4ff; }
        .upload-icon { font-size: 48px; color: #667eea; margin-bottom: 15px; }
        .upload-text { color: #666; margin-bottom: 10px; }
        .upload-hint { font-size: 12px; color: #999; }
        .camera-button { background: #667eea; color: white; border: none; border-radius: 25px; padding: 15px 30px; font-size: 16px; font-weight: 600; cursor: pointer; margin-bottom: 15px; width: 100%; transition: all 0.3s ease; }
        .camera-button:hover { background: #5a6fd8; transform: translateY(-2px); }
        .file-input { display: none; }
        .preview { margin-top: 20px; display: none; }
        .preview img { max-width: 100%; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .upload-button { background: #28a745; color: white; border: none; border-radius: 25px; padding: 15px 30px; font-size: 16px; font-weight: 600; cursor: pointer; width: 100%; margin-top: 15px; transition: all 0.3s ease; display: none; }
        .upload-button:hover { background: #218838; }
        .upload-button:disabled { background: #6c757d; cursor: not-allowed; }
        .status { margin-top: 15px; padding: 10px; border-radius: 10px; font-size: 14px; display: none; }
        .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status.loading { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .loading-spinner { display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .session-info { background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 20px; font-size: 12px; color: #666; }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">ðŸ“± RAMQ Scan</div>
        <div class="subtitle">Upload mobile pour import</div>

        <div class="session-info" id="sessionInfo">Chargement de la session...</div>

        <div class="upload-area" id="uploadArea">
            <div class="upload-icon">ðŸ“¸</div>
            <div class="upload-text">Prenez une photo ou sÃ©lectionnez un fichier</div>
            <div class="upload-hint">Appuyez pour ouvrir l'appareil photo</div>
        </div>

        <button class="camera-button" id="cameraButton">ðŸ“· Prendre une photo</button>
        <input type="file" id="fileInput" class="file-input" accept="image/*" capture="environment">

        <div class="preview" id="preview"><img id="previewImage" alt="AperÃ§u"></div>

        <button class="upload-button" id="uploadButton">Envoyer l'image</button>
        <div class="status" id="status"></div>
    </div>

    <script>
        // Params
        const urlParams = new URLSearchParams(window.location.search);
        const sessionId = urlParams.get('session');
        const importType = urlParams.get('type') || 'clinical';
        const establishment = urlParams.get('establishment') || '12345';
        const API_BASE = window.location.origin; // Use same host:port as this page

        // UI refs
        const uploadArea = document.getElementById('uploadArea');
        const cameraButton = document.getElementById('cameraButton');
        const fileInput = document.getElementById('fileInput');
        const preview = document.getElementById('preview');
        const previewImage = document.getElementById('previewImage');
        const uploadButton = document.getElementById('uploadButton');
        const status = document.getElementById('status');

        // Session info
        document.getElementById('sessionInfo').innerHTML = `
            <strong>Session:</strong> ${sessionId ? sessionId.slice(0, 8) + '...' : 'Non trouvÃ©e'}<br>
            <strong>Type:</strong> ${importType === 'clinical' ? 'Horaire clinique' : 'Fiche de garde'}<br>
            <strong>Ã‰tablissement:</strong> ${establishment}
        `;

        // Helpers
        function showStatus(message, type) {
            status.textContent = message;
            status.className = `status ${type}`;
            status.style.display = 'block';
            if (type === 'loading') {
                status.innerHTML = `<span class="loading-spinner"></span>${message}`;
            }
        }

        function dataURLToImage(dataUrl) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => resolve(img);
                img.onerror = reject;
                img.src = dataUrl;
            });
        }

        async function enhanceForAI(dataUrl) {
            // Load image
            const img = await dataURLToImage(dataUrl);
            // Resize keeping aspect ratio; target long side up to 1800px (smaller to ensure <10MB)
            const maxSide = 1800;
            const scale = Math.min(1, maxSide / Math.max(img.width, img.height));
            const targetW = Math.round(img.width * scale);
            const targetH = Math.round(img.height * scale);

            const canvas = document.createElement('canvas');
            canvas.width = targetW;
            canvas.height = targetH;
            const ctx = canvas.getContext('2d');

            // Improve readability: increase contrast/brightness slightly
            ctx.filter = 'contrast(118%) brightness(106%)';
            ctx.drawImage(img, 0, 0, targetW, targetH);

            // Export high-quality JPEG (slightly reduced quality to keep size down)
            const quality = 0.82;
            return canvas.toDataURL('image/jpeg', quality);
        }

        async function handleFile(file) {
            if (!file.type.startsWith('image/')) {
                showStatus('Veuillez sÃ©lectionner une image', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    showStatus('Optimisation de l\'image...', 'loading');
                    const originalDataUrl = e.target.result;
                    const processedDataUrl = await enhanceForAI(originalDataUrl);

                    previewImage.src = processedDataUrl;
                    preview.style.display = 'block';
                    uploadButton.style.display = 'block';
                    uploadButton.onclick = () => uploadImage(processedDataUrl);
                    showStatus('PrÃªt Ã  envoyer', 'success');
                } catch (err) {
                    console.error('Enhancement error:', err);
                    // Fallback to original
                    previewImage.src = e.target.result;
                    preview.style.display = 'block';
                    uploadButton.style.display = 'block';
                    uploadButton.onclick = () => uploadImage(e.target.result);
                    showStatus('Image prÃªte (sans optimisation)', 'success');
                }
            };
            reader.readAsDataURL(file);
        }

        function uploadImage(dataUrl) {
            if (!sessionId) {
                showStatus('Session invalide', 'error');
                return;
            }

            const base64 = dataUrl.split(',')[1];
            showStatus('Envoi en cours...', 'loading');
            uploadButton.disabled = true;

            fetch(`${API_BASE}/api/upload/${sessionId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    fileName: 'mobile-capture.jpg',
                    fileSize: Math.round((base64.length * 0.75)),
                    imageBase64: base64,
                    metadata: { importType, establishment, source: 'mobile' }
                })
            })
            .then(resp => resp.json().catch(() => ({})).then(data => ({ ok: resp.ok, status: resp.status, data })))
            .then(({ ok, status, data }) => {
                if (ok && data.success) {
                    showStatus('Image envoyÃ©e avec succÃ¨s!', 'success');
                    setTimeout(() => { window.close(); }, 1200);
                } else {
                    console.error('Upload failed:', status, data);
                    showStatus(`Erreur lors de l'envoi (HTTP ${status}): ` + (data && (data.error || data.details) || 'Erreur inconnue'), 'error');
                    uploadButton.disabled = false;
                }
            })
            .catch(error => {
                console.error('Upload error:', error);
                showStatus('Erreur de connexion. VÃ©rifiez que vous Ãªtes sur le mÃªme Wiâ€‘Fi que l\'ordinateur.', 'error');
                uploadButton.disabled = false;
            });
        }

        // Events
        cameraButton.addEventListener('click', () => { fileInput.setAttribute('capture', 'environment'); fileInput.click(); });
        uploadArea.addEventListener('click', () => { fileInput.removeAttribute('capture'); fileInput.click(); });
        fileInput.addEventListener('change', (e) => { const file = e.target.files[0]; if (file) handleFile(file); });
        uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('dragover'); });
        uploadArea.addEventListener('dragleave', () => { uploadArea.classList.remove('dragover'); });
        uploadArea.addEventListener('drop', (e) => { e.preventDefault(); uploadArea.classList.remove('dragover'); const file = e.dataTransfer.files[0]; if (file && file.type.startsWith('image/')) handleFile(file); });

        // Mobile hint
        if (!/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
            showStatus('Cette page est optimisÃ©e pour mobile', 'error');
        }
    </script>
</body>
</html>
